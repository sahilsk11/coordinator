<!DOCTYPE HTML>
<head>
	<title>Coordinator - Change Username</title>
	<link href ="Helper/bootstrap.css" rel="stylesheet" type = "text/css">
	<link href ="Helper/organize.css" rel="stylesheet" type = "text/css">
	<link href="Helper/Images/icon.png" rel="icon">
	<script src="Helper/cookiesk.js" type="text/javascript">
	</script>
	<meta name = "viewport" content="initial-scale=1.0">
	<script src="Helper/jquery-2.2.4.min.js" type="text/javascript"></script>
	<script src="Helper/bootstrap.js" type="text/javascript"></script>
	<script src="Helper/XHRequest.js"></script>
	<script>
		var old_user;
		var new_user;
		var my_data = ""; //json
		var num_users; //number of users
		var code;

		//Username is null
		if (getUserCookie("name") == "" || getUserCookie("name") == null) {
			window.location = "createuser.html";
		}

		function setCode() {
			var url = window.location.toString();
			var start = url.indexOf("=");
			var end = url.indexOf("#");
			console.log(start);
			if (end == -1) {
				var code = url.substring(start+1);
			}
			else {
				var code = url.substring(start+1, end)
			}
			console.log(code);
		}

		function showUser() {
			document.getElementById("input_user").value = getUserCookie("name");
		}

		function invalidName() {
			document.getElementById("new").innerHTML = "<hr width='90%' class='next'>\
					    <h2 class='text-center'>There was an error finding your information in the database.</h2>\
						<h2 class='text-center'><a href='createuser.html'>Please click here to go create a new user.</a></h2>";
		}

		function saveUser() {
			var user = document.getElementById("input_user").value;
			saveNew(user);
		}

		function changeUser(olduser, newuser) {
			XHRequest.createRequest({
				success: successChange, 
				method: "GET",
				params: {
					command: "change_user",
					old_user: olduser,
					new_user: newuser
				},
				url: "/coordinator/scripts/datbase.py"
			});
		}

		function successChange(xhr, xhrConfig) {
			my_data = JSON.parse(xhr.responseText);
			var response = my_data.complete;
			if (response == "True") {
				displaySuccess();
			}
			else if (response == "Notfound") {
				invalidName();
			}
			else {
				displayUsed();
			}
			console.log("data retrieved");
			setUserCookie("name", new_user);
		}

		function displaySuccess() {
			document.getElementById("new").innerHTML = "<hr width='90%' class='next'>\
					    <h2 class='text-center'>Your new username is " + new_user +  ".</h2>\
						<h2 class='text-center'><a href='event.html?event='" + code + ">Click here to go back to the main page.</a></h2>";
		}

		function displayUsed() {
			document.getElementById("new").innerHTML = "<hr width='90%' class='next'>\
					    <h2 class='text-center'>Username taken</h2>";
		}

		function textValid(text) {
			if (text=="" || text.length <= 1) {
		    	document.getElementById("new").innerHTML = "<hr width='90%'\
		    	 class='next'><h2 class='text-center'>\
		    	 	Please Enter a Valid Username.\
		    	 </h2><br><p class='text-center'>A valid username contains more than one character and should provide description of who you are.</p>"
		    	return false;
			}
			return true;
		}

		function saveNew(user) {
			old_user = getUserCookie("name");
		    if (textValid(user)) {
		    	new_user = user;
		    	if (new_user !== old_user) {
					changeUser(old_user, new_user);
		    	}
		    	else {
		    		displaySuccess();
		    	}
		    }
		}
	</script>
</head>

<body class="static-nav" onload="showUser()">
		<nav class="navbar-inverse special-font mid-font nav-font">
			<div class="container-fluid">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
			      		<span class="sr-only">Toggle navigation</span>
			      		<span class="icon-bar"></span>
			      		<span class="icon-bar"></span>
			      		<span class="icon-bar"></span>
		        	</button>
	    			<a href="index.html" class="navbar-brand">
	    				<img src="Helper/Images/co-grey.png" class="logo" onmouseover="this.src='Helper/Images/co-white.png'" onmouseout="this.src='Helper/Images/co-grey.png'">
	    			</a>
				</div>
	    		<div id="navbar" class="navbar-collapse collapse">
	    			<ul class="nav navbar-nav theme">
	      				<li class=""><a href="index.html">Home</a></li>
	      				<li class="active"><a href="newevent.html">Create a New Event</a></li>
	      				<li id="inuser" class="dropdown">
	      					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">User Settings</a>
							<ul class="dropdown-menu">
				            	<li><a href="#">You are not in an event<br>Please join an event to change user settings.</a></li>
				          	</ul>
				        </li>
				        <li class="dropdown">
				        	<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Event <span class="caret"></span></a>
				        	<ul id="indestination" class="dropdown-menu">
				        		<li><a href="#">You are not in an event<br>Please join an even to go to your event.</a></li>
				        	</ul>
				        </li>
	      				<li><a href="#">GitHub Page</a></li>
	    			</ul>
	    		</div>
	 		</div>
		</nav>
	<div class="text-center">
		<img src="Helper/Images/co.png" class="page-logo">
		<hr width="65%" class="next-close">
		<br>
	</div>
	<div class="col-xs-6">
		<form class="form-horizontal col-xs-11">
	 		<div class="form-group">
	    		<label class='control-label'>New Username:</label>
	  			<input id="input_user" class='form-control' onkeydown="if (event.keyCode == 13) {saveUser();return false;}">
	  			</input>
	  			<br>
	  			<button type='button' onClick='saveUser()' class='btn btn-default'>Submit</button>
	  		</div>
		</form>
	</div>


	<div id="new">
	</div>


</body>

