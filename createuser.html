<!DOCTYPE HTML>
<html lang = "en">
	<head>
		<title>Coordinator - Create New User</title>
		<link href ="Helper/bootstrap.css" rel="stylesheet" type = "text/css">
		<link href ="Helper/organize.css" rel="stylesheet" type = "text/css">
		<link href="Helper/Images/icon.png" rel="icon">
		<script src="Helper/cookiesk.js" type="text/javascript">
		</script>
		<meta name = "viewport" content="initial-scale=1.0">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<script src="Helper/jquery-2.2.4.min.js" type="text/javascript"></script>
		<script src="Helper/bootstrap.js" type="text/javascript"></script>
		<script src="Helper/XHRequest.js"></script>
		<script>
			var lat = "";
			var lon = "";
			showLocation();
			function showLocation () {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(showPosition);
				}
				else {
					document.getElementById("wait").innerHTML = "Could not find location.";
				}
			}


			

			function showPosition(position) {
				lat = position.coords.latitude;
				lon = position.coords.longitude;
				console.log("Location input");
				document.getElementById("submit").disabled = "";
				document.getElementById("wait").innerHTML = "";
			}

			function checkUserExist() {
				
			}
			//call
			function saveUser() {
				var user = document.getElementById("input_user").value;
				saveNew(user);
			}

			function textValid(text) {
				if (text=="" || text.length <= 1) {
			    	document.getElementById("new").innerHTML = "<hr width='90%' class='next'>\
			    		<h2 class='text-center'>Please Enter a Valid Username.</h2>\
			    		<br><p class='text-center'>\
			    		A valid username contains more than one character and should provide description of who you are.\
			    		</p>"
			    	return false;
				}
				return true;
			}

			function displaySuccess(user) {
				document.getElementById("new").innerHTML = "<hr width='90%' class='next'>\
				    <h2 class='text-center'>Your new username is " + user +  ".</h2>\
					<h2 class='text-center'><a href='event.html'>Click here to go back to the main page.</a></h2>";
			}

			function displayUsed() {
			document.getElementById("new").innerHTML = "<hr width='90%' class='next'>\
					    <h2 class='text-center'>Username taken</h2>";
			}

			function displayError() {
				document.getElementById("new").innerHTML = "<hr width='90%' class='next'>\
				    <h2 class='text-center'><a href='newevent.html'>Please Enter the Destination</a></h2>";
			}

			function addNewUser(user) {
				function success1(xhr, xhrConfig) {
					var my_data = JSON.parse(xhr.responseText);
					if (lat != "") {
						if (my_data.complete == "True") {
							displaySuccess(user);
							setUserCookie("name", user);
							console.log(user);
						}
						else if (my_data.complete == "Incomplete") {
							displayError();
						}
						else {
							if (getUserCookie("name") === user) {
								displaySuccess(user);
								setUserCookie("name", user);
								console.log(user);
								}
								displayUsed();
						}
					}
					else {
						displayError();
					}

	    		}
	    		XHRequest.createRequest({
					success: success1, 
					method: "GET",
					params: {
						command: "add_user",
						user: user,
						lat: lat,
						lon: lon
					},
					url: "/coordinator/scripts/datbase.py"
				});
			}

			function saveNew(user) {
			    if (textValid(user)) {
			    	addNewUser(user);
				
			    }
			}
		</script>
	</head>

	<body class="static-nav">
		<nav class="navbar-inverse">
			<div class="container-fluid">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
			      		<span class="sr-only">Toggle navigation</span>
			      		<span class="icon-bar"></span>
			      		<span class="icon-bar"></span>
			      		<span class="icon-bar"></span>
		        	</button>
	    			<a href="index.html" class="navbar-brand">
	    				<img src="Helper/Images/co-grey.png" class="logo" onmouseover="this.src='Helper/Images/co-white.png'" onmouseout="this.src='Helper/Images/co-grey.png'">
	    			</a>
				</div>
	    		<div id="navbar" class="navbar-collapse collapse">
	    			<ul class="nav navbar-nav theme">
	      				<li><a href="index.html">Home</a></li>
	      				<li><a href="newevent.html">Create a New Event</a></li>
	      				<li><a href="changeuser.html">Change Username</a></li>
	      				<li><a href="www.iotspace.tech">Back to IoT Space</a></li>
	    			</ul>
	    		</div>
	 		</div>
		</nav>
		<div class="text-center">
			<img src="Helper/Images/co.png" class="page-logo">
			<hr width="65%" class="next-close">
			<br>
		</div>
		<br>
		<div class="col-xs-6">
			<form id="userform" class="form-horizontal col-xs-11">
		 		<div class="form-group">
		    		<label class='control-label'>New Username:</label>
		  			<input id="input_user" class='form-control'>
		  			</input>
		  			<br>
		  			<button id="submit" type='button' onClick='saveUser()' disabled="disabled" class='btn btn-default'>Submit</button>
	  			</div>
			</form>
		</div>
		<p id="wait" class="lead">Loading...</p>

		<div>
			<p class="lead col-xs-6">You can change your username whenever you want from the Change Username screen. Your username should be more than one character and provide a description of who you are.</p>
		</div>
		<div id="new"></div>
	</body>
</html>